<!DOCTYPE html>
<html lang="bg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Exam Monitor v2</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title h1 {
            margin: 0;
            font-size: 24px;
        }

        .header-title .subtitle {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 14px;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .user-welcome {
            font-size: 16px;
            font-weight: 500;
        }

        .user-session {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        /* NEW: Connection status and session controls */
        .dashboard-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #dc3545;
            transition: background-color 0.3s;
        }

        .connection-indicator.connected {
            background-color: #28a745;
            animation: pulse 2s infinite;
        }

        .connection-indicator.reconnecting {
            background-color: #ffc107;
            animation: flash 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes flash {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }

        .session-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #1e7e34;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #e0a800;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #c82333;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-card.active .number {
            color: #28a745;
        }

        .stat-card.disconnected .number {
            color: #ffc107;
        }

        .stat-card.violations .number {
            color: #dc3545;
        }

        .stat-card.completed .number {
            color: #6c757d;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .student-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .student-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .student-class {
            color: #666;
            font-size: 14px;
            margin-top: 2px;
        }

        .student-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #28a745;
            animation: pulse 2s infinite;
        }

        .status-indicator.disconnected {
            background-color: #ffc107;
        }

        .status-indicator.suspicious {
            background-color: #dc3545;
        }

        .status-indicator.completed {
            background-color: #6c757d;
            animation: none;
        }

        .student-info {
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-label {
            color: #666;
            font-weight: 500;
        }

        .info-value {
            color: #333;
            font-weight: 600;
        }

        .fullscreen-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .fullscreen-status.active {
            background-color: #d4edda;
            color: #155724;
        }

        .fullscreen-status.violation {
            background-color: #f8d7da;
            color: #721c24;
        }

        .fullscreen-status.inactive {
            background-color: #e2e3e5;
            color: #6c757d;
        }

        .code-preview {
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            margin-bottom: 15px;
        }

        .activity-log {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
            max-height: 120px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            color: #999;
            font-size: 11px;
        }

        .warning {
            color: #dc3545;
            font-weight: 600;
        }

        .violation-alert {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: 500;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .no-students {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-students h3 {
            margin-bottom: 10px;
        }

        /* NEW: Notification system */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #28a745;
        }

        .notification.warning {
            background-color: #ffc107;
            color: #212529;
        }

        .notification.error {
            background-color: #dc3545;
        }

        .notification.info {
            background-color: #17a2b8;
        }

        /* NEW: Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #ccc;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* File Management Styles */
        .file-management-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-header h2 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 180px;
        }

        .file-upload-area {
            margin-bottom: 25px;
        }

        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .upload-zone.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-zone p {
            margin: 10px 0;
            color: #666;
            font-size: 16px;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .upload-buttons .control-btn {
            padding: 10px 20px;
            font-size: 14px;
        }

        .files-info-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }

        .info-box {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 25px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }

        .info-icon {
            font-size: 48px;
            flex-shrink: 0;
        }

        .info-content h3 {
            margin: 0 0 10px 0;
            color: #28a745;
            font-size: 16px;
        }

        .info-content p {
            margin: 5px 0;
            color: #6c757d;
            font-size: 14px;
            line-height: 1.4;
        }

        .loading-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }

        .upload-info {
            margin-top: 10px;
        }

        .upload-info small {
            color: #888;
            font-size: 12px;
        }

        .upload-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }

        .current-files h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .file-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            transition: all 0.2s ease;
        }

        .file-card:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .file-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .file-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .file-actions-card {
            display: flex;
            gap: 5px;
        }

        .file-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .file-btn.edit {
            background: #17a2b8;
            color: white;
        }

        .file-btn.delete {
            background: #dc3545;
            color: white;
        }

        .file-btn:hover {
            opacity: 0.8;
        }

        .no-files-message {
            grid-column: 1 / -1;
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 40px 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #ddd;
        }

        /* Help Chat Styles */
        .help-chat-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            overflow: hidden;
        }

        .help-chat-section .section-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-chat-section .section-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
        }

        .chat-container {
            padding: 20px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .student-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .student-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .student-class {
            font-size: 14px;
            color: #666;
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-status {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #e7f5e7;
            color: #2d5a2d;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            margin-bottom: 15px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }

        .chat-message.student {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .chat-message.teacher {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            margin-left: auto;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .message-sender {
            font-weight: bold;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: #666;
        }

        .message-content {
            line-height: 1.4;
            color: #333;
        }

        .chat-typing-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .typing-animation {
            display: flex;
            gap: 3px;
        }

        .typing-animation span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-animation span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-animation span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .typing-text {
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .chat-input-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .chat-input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-input-wrapper textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            font-size: 14px;
        }

        .chat-input-wrapper textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .chat-input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .char-counter {
            font-size: 12px;
            color: #666;
        }

        .char-counter.warning {
            color: #dc3545;
        }

        .help-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }

        .help-notification.success {
            background: #28a745;
        }

        .help-notification.info {
            background: #17a2b8;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Pulse animation for help requests */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }

        /* Exam Settings Styles */
        .exam-settings-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px 0;
            overflow: hidden;
        }

        .exam-settings-section .section-header {
            background: linear-gradient(135deg, #6f42c1 0%, #8b5fbf 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .exam-settings-section .section-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .settings-container {
            padding: 20px;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .setting-group label {
            font-weight: bold;
            min-width: 160px;
            color: #333;
        }

        .setting-group input[type="number"] {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .setting-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .setting-description {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>Teacher Dashboard - Exam Monitor v2</h1>
                <div class="subtitle">üîí Fullscreen Mode ‚Ä¢ Smart reconnection & session management</div>
            </div>
            <div class="header-user">
                <div class="user-info">
                    <span class="user-welcome">Welcome, <span id="teacher-name">Teacher</span></span>
                    <span class="user-session" id="session-info">Session active</span>
                </div>
                <button class="logout-btn" id="logout-btn" title="Logout">
                    üö™ Logout
                </button>
            </div>
        </div>
    </div>

    <!-- NEW: Dashboard Controls -->
    <div class="dashboard-controls">
        <div class="connection-status">
            <div class="connection-indicator" id="connection-indicator"></div>
            <span id="connection-text">Connecting...</span>
            <span id="last-update"></span>
        </div>

        <div class="session-controls">
            <button class="control-btn btn-success" id="new-session-btn" title="Start new exam session">
                üÜï New Session
            </button>
            <button class="control-btn btn-primary" id="refresh-btn" title="Refresh data">
                üîÑ Refresh
            </button>
            <button class="control-btn btn-warning" id="export-btn" title="Export exam data">
                üìä Export
            </button>
            <button class="control-btn btn-danger" id="emergency-stop-btn" title="Emergency stop all exams">
                üõë Emergency Stop
            </button>
        </div>
    </div>

    <!-- Exam Settings -->
    <div class="exam-settings-section">
        <div class="section-header">
            <h2>‚è±Ô∏è Exam Settings</h2>
        </div>
        
        <div class="settings-container">
            <div class="setting-group">
                <div class="info-box">
                    <div class="info-icon">‚è±Ô∏è</div>
                    <div class="info-content">
                        <h3>Exam Duration: 180 minutes</h3>
                        <p>To change exam duration, edit <strong>config/exam-config.json</strong></p>
                        <p>Development mode: <strong>Enabled</strong> (allows F12 for testing)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Files Info -->
    <div class="file-management-section">
        <div class="section-header">
            <h2>üìÅ Exam Project Files</h2>
        </div>
        
        <div class="files-info-panel">
            <div class="info-box">
                <div class="info-icon">üìÇ</div>
                <div class="info-content">
                    <h3>Files served from: practice-server/exam-files/</h3>
                    <p>To add/modify exam files, place them in the <strong>practice-server/exam-files/</strong> directory.</p>
                    <p>Students will automatically receive these files when they start the exam.</p>
                </div>
            </div>
            
            <div class="current-files">
                <h3>üìã Available Project Files</h3>
                <div class="files-grid" id="current-files-grid">
                    <div class="loading-message">
                        Loading project files...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-card active">
            <h3>Active Students</h3>
            <div class="number" id="active-count">0</div>
        </div>
        <div class="stat-card disconnected">
            <h3>Disconnected</h3>
            <div class="number" id="disconnected-count">0</div>
        </div>
        <div class="stat-card violations">
            <h3>Security Violations</h3>
            <div class="number" id="violations-count">0</div>
        </div>
        <div class="stat-card completed">
            <h3>Completed</h3>
            <div class="number" id="completed-count">0</div>
        </div>
    </div>

    <div id="students-container">
        <div class="no-students">
            <h3>No Active Students</h3>
            <p>Students will appear here when they join the exam</p>
        </div>
    </div>

    <!-- Help Chat Section -->
    <div class="help-chat-section" id="help-chat-section" style="display: none;">
        <div class="section-header">
            <h2>üí¨ Help Chat</h2>
            <div class="chat-controls">
                <button class="control-btn btn-secondary" id="minimize-chat-btn">
                    üìâ Minimize
                </button>
                <button class="control-btn btn-danger" id="close-chat-btn">
                    ‚ùå Close
                </button>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="chat-header">
                <div class="student-info">
                    <span class="student-name" id="chat-student-name">Student Name</span>
                    <span class="student-class" id="chat-student-class">Class</span>
                </div>
                <div class="chat-status">
                    <span class="connection-status" id="chat-connection-status">üü¢ Connected</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chat-messages">
                <!-- Messages will be populated here -->
            </div>
            
            <div class="chat-typing-indicator" id="chat-typing-indicator" style="display: none;">
                <div class="typing-animation">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="typing-text">Student is typing...</span>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="chat-input" 
                        placeholder="Type your response here..."
                        rows="2"
                        maxlength="1000"
                    ></textarea>
                    <div class="chat-input-actions">
                        <span class="char-counter" id="chat-char-counter">0/1000</span>
                        <button id="send-response-btn" class="control-btn btn-primary" disabled>
                            üì§ Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        class SmartTeacherDashboard {
            constructor() {
                this.socket = null;
                this.students = new Map();
                this.connectionState = 'disconnected';
                this.lastDataUpdate = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
                this.dataRefreshInterval = null;
                this.heartbeatInterval = null;
                this.isInitialized = false;
                this.teacherInfo = null;

                this.stats = {
                    active: 0,
                    disconnected: 0,
                    violations: 0,
                    completed: 0
                };

                this.checkAuthentication();
                this.initializeUI();
                this.connectToServer();
            }

            /**
             * Check if teacher is authenticated
             */
            async checkAuthentication() {
                try {
                    const response = await fetch('/api/teacher/verify-session', {
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (data.authenticated) {
                        this.teacherInfo = data.teacher;
                        this.updateTeacherInfo();
                    } else {
                        // Not authenticated, redirect to login
                        window.location.href = '/teacher/login.html';
                        return;
                    }
                } catch (error) {
                    console.error('Authentication check failed:', error);
                    window.location.href = '/teacher/login.html';
                }
            }

            /**
             * Update teacher info in header
             */
            updateTeacherInfo() {
                if (!this.teacherInfo) return;
                
                const teacherNameEl = document.getElementById('teacher-name');
                const sessionInfoEl = document.getElementById('session-info');
                
                if (teacherNameEl) {
                    teacherNameEl.textContent = this.teacherInfo.displayName || this.teacherInfo.username;
                }
                
                if (sessionInfoEl) {
                    const loginTime = new Date(this.teacherInfo.loginTime);
                    const duration = Math.floor((Date.now() - this.teacherInfo.loginTime) / 1000 / 60);
                    sessionInfoEl.textContent = `Logged in ${duration} min ago`;
                }
            }

            /**
             * Handle teacher logout
             */
            async handleLogout() {
                try {
                    const response = await fetch('/api/teacher/logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Disconnect socket before redirect
                        if (this.socket) {
                            this.socket.disconnect();
                        }
                        
                        // Clear any intervals
                        if (this.dataRefreshInterval) {
                            clearInterval(this.dataRefreshInterval);
                        }
                        if (this.heartbeatInterval) {
                            clearInterval(this.heartbeatInterval);
                        }
                        
                        // Redirect to login
                        window.location.href = '/teacher/login.html';
                    } else {
                        this.showNotification('Logout failed', 'error');
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    this.showNotification('Logout error', 'error');
                }
            }

            /**
             * Initialize UI event handlers
             */
            initializeUI() {
                // Control buttons
                document.getElementById('new-session-btn').addEventListener('click', () => {
                    this.startNewSession();
                });

                document.getElementById('refresh-btn').addEventListener('click', () => {
                    this.manualRefresh();
                });

                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('emergency-stop-btn').addEventListener('click', () => {
                    this.emergencyStop();
                });

                // Logout button
                document.getElementById('logout-btn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to logout?')) {
                        this.handleLogout();
                    }
                });

                // Update teacher info every minute
                setInterval(() => {
                    this.updateTeacherInfo();
                }, 60000);

                // Initialize chat UI
                this.initializeChatUI();

                // Initialize exam settings
                this.initializeExamSettings();

                console.log('‚úÖ Smart Teacher Dashboard UI initialized');
            }

            /**
             * Initialize chat UI handlers
             */
            initializeChatUI() {
                const input = document.getElementById('chat-input');
                const sendButton = document.getElementById('send-response-btn');
                const minimizeButton = document.getElementById('minimize-chat-btn');
                const closeButton = document.getElementById('close-chat-btn');

                if (input) {
                    input.addEventListener('input', () => {
                        this.updateCharCounter();
                        this.updateSendButton();
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendHelpResponse();
                        }
                    });
                }

                if (sendButton) {
                    sendButton.addEventListener('click', () => {
                        this.sendHelpResponse();
                    });
                }

                if (minimizeButton) {
                    minimizeButton.addEventListener('click', () => {
                        document.getElementById('help-chat-section').style.display = 'none';
                    });
                }

                if (closeButton) {
                    closeButton.addEventListener('click', () => {
                        document.getElementById('help-chat-section').style.display = 'none';
                        this.currentChatStudentId = null;
                        this.currentChatStudent = null;
                    });
                }
            }

            /**
             * Initialize exam settings display (read-only)
             */
            initializeExamSettings() {
                console.log('Exam settings are read-only - edit config/exam-config.json to change');
            }

            // Exam settings loading removed - now static display

            // Exam duration, development mode, and start exam methods removed
            // Settings are now configured via config/exam-config.json

            /**
             * Connect to server with smart reconnection
             */
            connectToServer() {
                this.updateConnectionStatus('connecting');

                // Disconnect existing socket if any
                if (this.socket) {
                    this.socket.removeAllListeners();
                    this.socket.disconnect();
                }

                this.socket = io({
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    forceNew: true
                });

                this.setupSocketHandlers();
            }

            /**
             * Setup socket event handlers
             */
            setupSocketHandlers() {
                // Connection events
                this.socket.on('connect', () => {
                    this.handleConnection();
                });

                this.socket.on('disconnect', (reason) => {
                    this.handleDisconnection(reason);
                });

                this.socket.on('connect_error', (error) => {
                    this.handleConnectionError(error);
                });

                // Teacher-specific events
                this.socket.on('all-students', (students) => {
                    this.updateAllStudents(students);
                });

                this.socket.on('student-connected', (data) => {
                    this.addStudent(data);
                });

                this.socket.on('student-disconnected', (data) => {
                    this.updateStudentStatus(data.sessionId, 'disconnected', data);
                });

                this.socket.on('student-code-update', (data) => {
                    this.updateStudentCode(data);
                });

                this.socket.on('student-suspicious', (data) => {
                    this.addSuspiciousActivity(data);
                });

                this.socket.on('student-fullscreen-status', (data) => {
                    this.updateFullscreenStatus(data);
                });

                this.socket.on('student-fullscreen-violation', (data) => {
                    this.handleFullscreenViolation(data);
                });

                this.socket.on('student-terminated', (data) => {
                    this.handleStudentTermination(data);
                });

                // Help chat events
                this.socket.on('student-help-request', (data) => {
                    this.handleHelpRequest(data);
                });

                this.socket.on('student-typing', (data) => {
                    this.handleStudentTyping(data);
                });

                this.socket.on('help-response-sent', (data) => {
                    this.handleResponseSent(data);
                });

                this.socket.on('help-response-error', (data) => {
                    this.handleResponseError(data);
                });

                console.log('üîó Socket handlers configured');
            }

            /**
             * Handle successful connection
             */
            handleConnection() {
                console.log('‚úÖ Connected to server');
                this.updateConnectionStatus('connected');
                this.reconnectAttempts = 0;

                // Send teacher join only once on connect
                if (!this.isInitialized) {
                    this.socket.emit('teacher-join');
                    this.isInitialized = true;
                    this.showNotification('Connected to exam server', 'success');
                }

                // Setup smart data refresh (only when needed)
                this.setupSmartRefresh();
                this.setupHeartbeat();
            }

            /**
             * Handle disconnection
             */
            handleDisconnection(reason) {
                console.warn('üîå Disconnected:', reason);
                this.updateConnectionStatus('disconnected');
                this.clearIntervals();

                // Don't auto-reconnect for intentional disconnects
                if (reason === 'io server disconnect' || reason === 'client namespace disconnect') {
                    this.showNotification('Disconnected from server', 'warning');
                    return;
                }

                // Auto-reconnect for network issues
                this.attemptReconnection();
            }

            /**
             * Handle connection errors
             */
            handleConnectionError(error) {
                console.error('‚ùå Connection error:', error);
                this.updateConnectionStatus('error');
                this.attemptReconnection();
            }

            /**
             * Attempt smart reconnection
             */
            attemptReconnection() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    this.showNotification('Failed to reconnect. Please refresh the page.', 'error');
                    return;
                }

                this.reconnectAttempts++;
                this.updateConnectionStatus('reconnecting');

                const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1); // Exponential backoff

                console.log(`üîÑ Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);

                setTimeout(() => {
                    this.connectToServer();
                }, delay);
            }

            /**
             * Setup smart data refresh (only when tab is visible and data is stale)
             */
            setupSmartRefresh() {
                // Clear existing interval
                if (this.dataRefreshInterval) {
                    clearInterval(this.dataRefreshInterval);
                }

                // Only refresh when page is visible and data is older than 10 seconds
                this.dataRefreshInterval = setInterval(() => {
                    if (document.hidden) return; // Don't refresh when tab is not visible

                    const now = Date.now();
                    if (!this.lastDataUpdate || (now - this.lastDataUpdate) > 10000) {
                        this.requestDataUpdate();
                    }
                }, 15000); // Check every 15 seconds
            }

            /**
             * Setup heartbeat to detect connection issues
             */
            setupHeartbeat() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                }

                this.heartbeatInterval = setInterval(() => {
                    if (this.socket?.connected) {
                        this.socket.emit('heartbeat');
                    }
                }, 30000); // Every 30 seconds
            }

            /**
             * Request data update (smart refresh)
             */
            requestDataUpdate() {
                if (this.socket?.connected) {
                    console.log('üîÑ Requesting data update');
                    this.socket.emit('teacher-join'); // This will trigger 'all-students' response
                }
            }

            /**
             * Manual refresh triggered by user
             */
            manualRefresh() {
                if (!this.socket?.connected) {
                    this.showNotification('Not connected to server', 'warning');
                    return;
                }

                this.showNotification('Refreshing data...', 'info');
                this.socket.emit('teacher-join');

                // Add loading state
                document.body.classList.add('loading');
                setTimeout(() => {
                    document.body.classList.remove('loading');
                }, 1000);
            }

            /**
             * Start new exam session
             */
            startNewSession() {
                if (confirm('Start a new exam session? This will clear current session data.')) {
                    // Implementation for starting new session
                    this.showNotification('New session started', 'success');
                    this.socket.emit('new-exam-session');
                }
            }

            /**
             * Export exam data
             */
            exportData() {
                // Implementation for exporting data
                this.showNotification('Exporting data...', 'info');
                // Create and download export file
                const data = {
                    timestamp: new Date().toISOString(),
                    students: Array.from(this.students.values()),
                    stats: this.stats
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `exam-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            /**
             * Emergency stop all exams
             */
            emergencyStop() {
                if (confirm('EMERGENCY STOP: This will terminate all active exams. Are you sure?')) {
                    this.socket.emit('emergency-stop-all');
                    this.showNotification('Emergency stop initiated', 'warning');
                }
            }

            /**
             * Update connection status UI
             */
            updateConnectionStatus(status) {
                this.connectionState = status;
                const indicator = document.getElementById('connection-indicator');
                const text = document.getElementById('connection-text');

                indicator.className = 'connection-indicator';

                switch (status) {
                    case 'connected':
                        indicator.classList.add('connected');
                        text.textContent = 'Connected';
                        break;
                    case 'connecting':
                        text.textContent = 'Connecting...';
                        break;
                    case 'reconnecting':
                        indicator.classList.add('reconnecting');
                        text.textContent = `Reconnecting... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`;
                        break;
                    case 'disconnected':
                        text.textContent = 'Disconnected';
                        break;
                    case 'error':
                        text.textContent = 'Connection Error';
                        break;
                }

                // Update control buttons state
                const buttons = document.querySelectorAll('.control-btn');
                buttons.forEach(btn => {
                    btn.disabled = status !== 'connected';
                });
            }

            /**
             * Update all students data
             */
            updateAllStudents(students) {
                this.students.clear();
                students.forEach(student => {
                    this.students.set(student.sessionId, {
                        ...student,
                        fullscreenStatus: 'unknown',
                        violationCount: 0,
                        activities: []
                    });
                });
                this.renderStudents();
                this.updateStats();
                this.lastDataUpdate = Date.now();
                this.updateLastUpdateTime();
            }

            /**
             * Add new student
             */
            addStudent(data) {
                this.students.set(data.sessionId, {
                    ...data,
                    status: 'active',
                    fullscreenStatus: 'entering',
                    violationCount: 0,
                    activities: [],
                    code: '',
                    lastActivity: Date.now()
                });
                this.renderStudents();
                this.updateStats();
                this.showNotification(`Student joined: ${data.studentName}`, 'info');
            }

            /**
             * Update student status
             */
            updateStudentStatus(sessionId, status, data = {}) {
                const student = this.students.get(sessionId);
                if (student) {
                    student.status = status;
                    student.lastActivity = Date.now();
                    if (data.reason) {
                        student.disconnectReason = data.reason;
                    }
                    this.renderStudents();
                    this.updateStats();
                }
            }

            /**
             * Update student code
             */
            updateStudentCode(data) {
                const student = this.students.get(data.sessionId);
                if (student) {
                    student.code = data.code;
                    student.lastActivity = Date.now();
                    this.renderStudent(student);
                }
            }

            /**
             * Add suspicious activity
             */
            addSuspiciousActivity(data) {
                const student = this.students.get(data.sessionId);
                if (student) {
                    if (!student.activities) student.activities = [];
                    student.activities.unshift({
                        type: 'suspicious',
                        activity: data.activity,
                        severity: data.severity,
                        timestamp: Date.now()
                    });

                    // Keep only last 10 activities
                    if (student.activities.length > 10) {
                        student.activities = student.activities.slice(0, 10);
                    }

                    this.renderStudent(student);
                    this.updateStats();

                    if (data.severity === 'high' || data.severity === 'critical') {
                        this.showNotification(`‚ö†Ô∏è ${data.activity}: ${student.studentName}`, 'warning');
                    }
                }
            }

            /**
             * Update fullscreen status
             */
            updateFullscreenStatus(data) {
                const student = this.students.get(data.sessionId);
                if (student) {
                    student.fullscreenStatus = data.status;
                    student.lastActivity = Date.now();

                    if (!student.activities) student.activities = [];
                    student.activities.unshift({
                        type: 'fullscreen',
                        activity: data.status === 'entered' ? 'Entered fullscreen' : 'Exited fullscreen',
                        timestamp: data.timestamp
                    });

                    this.renderStudent(student);
                }
            }

            /**
             * Handle fullscreen violation
             */
            handleFullscreenViolation(data) {
                const student = this.students.get(data.sessionId);
                if (student) {
                    student.violationCount = data.attempt;
                    student.fullscreenStatus = 'violation';
                    student.lastViolation = data.reason;

                    if (!student.activities) student.activities = [];
                    student.activities.unshift({
                        type: 'violation',
                        activity: `Fullscreen violation #${data.attempt}: ${data.reason}`,
                        severity: 'critical',
                        timestamp: data.timestamp
                    });

                    this.renderStudent(student);
                    this.updateStats();
                    this.showNotification(`üö® Fullscreen violation: ${student.studentName}`, 'error');
                }
            }

            /**
             * Handle student termination
             */
            handleStudentTermination(data) {
                const student = this.students.get(data.sessionId);
                if (student) {
                    student.status = 'terminated';
                    student.terminationReason = data.reason;

                    this.renderStudent(student);
                    this.updateStats();
                    this.showNotification(`üö´ Exam terminated: ${student.studentName}`, 'error');
                }
            }

            /**
             * Render all students
             */
            renderStudents() {
                const container = document.getElementById('students-container');

                if (this.students.size === 0) {
                    container.innerHTML = `
                        <div class="no-students">
                            <h3>No Active Students</h3>
                            <p>Students will appear here when they join the exam</p>
                        </div>
                    `;
                    return;
                }

                const studentsArray = Array.from(this.students.values());
                studentsArray.sort((a, b) => b.lastActivity - a.lastActivity);

                container.innerHTML = `
                    <div class="students-grid">
                        ${studentsArray.map(student => this.renderStudentCard(student)).join('')}
                    </div>
                `;
            }

            /**
             * Render individual student
             */
            renderStudent(student) {
                const studentCard = document.querySelector(`[data-session-id="${student.sessionId}"]`);
                if (studentCard) {
                    studentCard.outerHTML = this.renderStudentCard(student);
                }
            }

            /**
             * Render student card HTML
             */
            renderStudentCard(student) {
                const timeAgo = this.formatTimeAgo(student.lastActivity);
                const codePreview = student.code ? student.code.substring(0, 200) + (student.code.length > 200 ? '...' : '') : 'No code yet';

                return `
                    <div class="student-card" data-session-id="${student.sessionId}">
                        <div class="student-header">
                            <div>
                                <div class="student-name">${student.studentName}</div>
                                <div class="student-class">${student.studentClass} ‚Ä¢ ${student.sessionId}</div>
                            </div>
                            <div class="student-status">
                                <div class="status-indicator ${student.status}"></div>
                                <span>${this.getStatusText(student.status)}</span>
                            </div>
                        </div>

                        ${this.renderViolationAlert(student)}
                        ${this.renderFullscreenStatus(student)}

                        <div class="student-info">
                            <div class="info-row">
                                <span class="info-label">Time Left:</span>
                                <span class="info-value">${student.formattedTimeLeft || 'Unknown'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Last Activity:</span>
                                <span class="info-value">${timeAgo}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Violations:</span>
                                <span class="info-value ${student.violationCount > 0 ? 'warning' : ''}">${student.violationCount || 0}</span>
                            </div>
                        </div>

                        <div class="code-preview">${codePreview}</div>

                        ${this.renderActivityLog(student)}
                        ${this.renderControls(student)}
                    </div>
                `;
            }

            /**
             * Render violation alert
             */
            renderViolationAlert(student) {
                if (student.violationCount > 0 && student.status !== 'terminated') {
                    return `
                        <div class="violation-alert">
                            ‚ö†Ô∏è ${student.violationCount} security violation${student.violationCount > 1 ? 's' : ''} detected
                            ${student.lastViolation ? `‚Ä¢ ${student.lastViolation}` : ''}
                        </div>
                    `;
                }
                return '';
            }

            /**
             * Render fullscreen status
             */
            renderFullscreenStatus(student) {
                const statusConfig = {
                    'entered': { class: 'active', icon: 'üîí', text: 'Fullscreen Active' },
                    'violation': { class: 'violation', icon: '‚ö†Ô∏è', text: 'Fullscreen Violation' },
                    'entering': { class: 'inactive', icon: '‚è≥', text: 'Entering Fullscreen' },
                    'unknown': { class: 'inactive', icon: '‚ùì', text: 'Fullscreen Unknown' }
                };

                const config = statusConfig[student.fullscreenStatus] || statusConfig.unknown;

                return `
                    <div class="info-row">
                        <span class="info-label">Fullscreen:</span>
                        <span class="fullscreen-status ${config.class}">
                            ${config.icon} ${config.text}
                        </span>
                    </div>
                `;
            }

            /**
             * Render activity log
             */
            renderActivityLog(student) {
                if (!student.activities || student.activities.length === 0) {
                    return '<div class="activity-log">No recent activity</div>';
                }

                const activities = student.activities.slice(0, 5).map(activity => `
                    <div class="activity-item">
                        <div class="${activity.type === 'violation' || activity.type === 'termination' ? 'warning' : ''}">
                            ${activity.activity}
                        </div>
                        <div class="activity-time">${this.formatTime(activity.timestamp)}</div>
                    </div>
                `).join('');

                return `
                    <div class="activity-log">
                        <strong>Recent Activity:</strong>
                        ${activities}
                    </div>
                `;
            }

            /**
             * Render student controls
             */
            renderControls(student) {
                if (student.status === 'terminated' || student.status === 'completed') {
                    return '';
                }

                const hasHelpRequest = student.hasHelpRequest || false;
                const chatButtonClass = hasHelpRequest ? 'btn-primary pulse' : 'btn-secondary';
                const chatButtonText = hasHelpRequest ? 'üí¨ Reply to Help' : 'üí¨ Open Chat';

                return `
                    <div class="controls">
                        <button class="btn ${chatButtonClass}" onclick="teacherDashboard.openStudentChat('${student.sessionId}', '${student.studentName}', '${student.studentClass}')">
                            ${chatButtonText}
                        </button>
                        <button class="btn btn-warning" onclick="teacherDashboard.warnStudent('${student.sessionId}')">
                            ‚ö†Ô∏è Send Warning
                        </button>
                        <button class="btn btn-danger" onclick="teacherDashboard.terminateStudent('${student.sessionId}')">
                            üö´ Terminate Exam
                        </button>
                    </div>
                `;
            }

            /**
             * Update statistics
             */
            updateStats() {
                const stats = { active: 0, disconnected: 0, violations: 0, completed: 0 };

                for (const student of this.students.values()) {
                    switch (student.status) {
                        case 'active':
                            stats.active++;
                            break;
                        case 'disconnected':
                            stats.disconnected++;
                            break;
                        case 'completed':
                        case 'terminated':
                            stats.completed++;
                            break;
                    }

                    if (student.violationCount > 0) {
                        stats.violations += student.violationCount;
                    }
                }

                this.stats = stats;

                document.getElementById('active-count').textContent = stats.active;
                document.getElementById('disconnected-count').textContent = stats.disconnected;
                document.getElementById('violations-count').textContent = stats.violations;
                document.getElementById('completed-count').textContent = stats.completed;
            }

            /**
             * Update last update time display
             */
            updateLastUpdateTime() {
                const lastUpdateEl = document.getElementById('last-update');
                if (this.lastDataUpdate) {
                    lastUpdateEl.textContent = `‚Ä¢ Updated ${this.formatTimeAgo(this.lastDataUpdate)}`;
                }
            }

            /**
             * Show notification
             */
            showNotification(message, type = 'info') {
                // Remove existing notifications
                const existingNotifications = document.querySelectorAll('.notification');
                existingNotifications.forEach(notif => notif.remove());

                // Create new notification
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;

                document.body.appendChild(notification);

                // Show notification
                setTimeout(() => notification.classList.add('show'), 100);

                // Hide notification after 5 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }

            /**
             * Clear all intervals
             */
            clearIntervals() {
                if (this.dataRefreshInterval) {
                    clearInterval(this.dataRefreshInterval);
                    this.dataRefreshInterval = null;
                }
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
            }

            /**
             * Utility methods
             */
            getStatusText(status) {
                const statusMap = {
                    'active': 'Active',
                    'disconnected': 'Disconnected',
                    'completed': 'Completed',
                    'terminated': 'Terminated',
                    'suspicious': 'Suspicious'
                };
                return statusMap[status] || status;
            }

            formatTimeAgo(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);

                if (hours > 0) return `${hours}h ago`;
                if (minutes > 0) return `${minutes}m ago`;
                return `${seconds}s ago`;
            }

            formatTime(timestamp) {
                return new Date(timestamp).toLocaleTimeString();
            }

            /**
             * Student action methods
             */
            warnStudent(sessionId) {
                const student = this.students.get(sessionId);
                if (student && confirm(`Send warning to ${student.studentName}?`)) {
                    this.socket.emit('send-warning', { sessionId, message: 'Please follow exam rules' });
                    this.showNotification(`Warning sent to ${student.studentName}`, 'warning');
                }
            }

            terminateStudent(sessionId) {
                const student = this.students.get(sessionId);
                if (student && confirm(`Terminate exam for ${student.studentName}?`)) {
                    this.socket.emit('terminate-student', { sessionId, reason: 'instructor_action' });
                    this.showNotification(`Terminating exam for ${student.studentName}`, 'error');
                }
            }

            /**
             * Open chat with specific student
             */
            openStudentChat(sessionId, studentName, studentClass) {
                this.openHelpChat({
                    sessionId: sessionId,
                    studentName: studentName,
                    studentClass: studentClass
                });
                
                // Mark help request as addressed
                const student = this.students.get(sessionId);
                if (student && student.hasHelpRequest) {
                    student.hasHelpRequest = false;
                    this.renderStudent(student);
                }
            }

            /**
             * Handle help request from student
             */
            handleHelpRequest(data) {
                // Mark student as having help request
                const student = this.students.get(data.sessionId);
                if (student) {
                    student.hasHelpRequest = true;
                    this.renderStudent(student);
                }
                
                this.showHelpNotification(data);
                this.openHelpChat(data);
                this.addChatMessage(data, 'student');
            }

            /**
             * Handle student typing indicator
             */
            handleStudentTyping(data) {
                if (data.isTyping) {
                    this.showTypingIndicator();
                } else {
                    this.hideTypingIndicator();
                }
            }

            /**
             * Handle response sent confirmation
             */
            handleResponseSent(data) {
                this.showNotification('Response sent successfully', 'success');
                this.addChatMessage({
                    message: this.lastSentMessage,
                    timestamp: data.timestamp,
                    teacherName: this.teacherInfo?.name || 'Teacher'
                }, 'teacher');
            }

            /**
             * Handle response error
             */
            handleResponseError(data) {
                this.showNotification('Failed to send response: ' + data.error, 'error');
            }

            /**
             * Show help notification
             */
            showHelpNotification(data) {
                const notification = document.createElement('div');
                notification.className = 'help-notification';
                notification.innerHTML = `
                    <strong>üÜò Help Request from ${data.studentName}</strong><br>
                    <small>${data.studentClass}</small><br>
                    ${data.message.length > 100 ? data.message.substring(0, 100) + '...' : data.message}
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);

                this.playNotificationSound();
            }

            /**
             * Open help chat window
             */
            openHelpChat(data) {
                const chatSection = document.getElementById('help-chat-section');
                const studentName = document.getElementById('chat-student-name');
                const studentClass = document.getElementById('chat-student-class');
                
                if (chatSection && studentName && studentClass) {
                    chatSection.style.display = 'block';
                    studentName.textContent = data.studentName;
                    studentClass.textContent = data.studentClass;
                    
                    this.currentChatStudentId = data.sessionId;
                    this.currentChatStudent = {
                        name: data.studentName,
                        class: data.studentClass,
                        sessionId: data.sessionId
                    };
                    
                    this.scrollChatToBottom();
                }
            }

            /**
             * Add message to chat
             */
            addChatMessage(data, sender) {
                const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) return;

                const messageElement = document.createElement('div');
                messageElement.className = `chat-message ${sender}`;
                
                const timestamp = new Date(data.timestamp).toLocaleTimeString('bg-BG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                if (sender === 'student') {
                    messageElement.innerHTML = `
                        <div class="message-header">
                            <span class="message-sender">${data.studentName}</span>
                            <span class="message-time">${timestamp}</span>
                        </div>
                        <div class="message-content">${this.escapeHtml(data.message)}</div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <div class="message-header">
                            <span class="message-sender">${data.teacherName || 'Teacher'}</span>
                            <span class="message-time">${timestamp}</span>
                        </div>
                        <div class="message-content">${this.escapeHtml(data.message)}</div>
                    `;
                }

                chatMessages.appendChild(messageElement);
                this.scrollChatToBottom();
            }

            /**
             * Show typing indicator
             */
            showTypingIndicator() {
                const indicator = document.getElementById('chat-typing-indicator');
                if (indicator) {
                    indicator.style.display = 'flex';
                    this.scrollChatToBottom();
                }
            }

            /**
             * Hide typing indicator
             */
            hideTypingIndicator() {
                const indicator = document.getElementById('chat-typing-indicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            /**
             * Scroll chat to bottom
             */
            scrollChatToBottom() {
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages) {
                    setTimeout(() => {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 50);
                }
            }

            /**
             * Send help response
             */
            sendHelpResponse() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                
                if (!message || !this.currentChatStudentId) return;

                this.lastSentMessage = message;
                
                this.socket.emit('help-response', {
                    studentId: this.currentChatStudentId,
                    message: message,
                    messageId: Date.now(),
                    teacherName: this.teacherInfo?.name || 'Teacher'
                });

                input.value = '';
                this.updateCharCounter();
                this.updateSendButton();
            }

            /**
             * Update character counter
             */
            updateCharCounter() {
                const input = document.getElementById('chat-input');
                const counter = document.getElementById('chat-char-counter');
                
                if (input && counter) {
                    const length = input.value.length;
                    counter.textContent = `${length}/1000`;
                    counter.className = length > 900 ? 'char-counter warning' : 'char-counter';
                }
            }

            /**
             * Update send button state
             */
            updateSendButton() {
                const input = document.getElementById('chat-input');
                const button = document.getElementById('send-response-btn');
                
                if (input && button) {
                    button.disabled = input.value.trim().length === 0;
                }
            }

            /**
             * Play notification sound
             */
            playNotificationSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(900, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(700, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(900, audioContext.currentTime + 0.2);
                    
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (error) {
                    // Fallback - no sound
                }
            }

            /**
             * Escape HTML to prevent XSS
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize smart dashboard
        const teacherDashboard = new SmartTeacherDashboard();

        // Update last update time every minute
        setInterval(() => {
            teacherDashboard.updateLastUpdateTime();
        }, 60000);

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // File Management Class
        class FileManager {
            constructor() {
                this.init();
            }

            init() {
                this.loadExamFiles();
            }

            async loadExamFiles() {
                try {
                    const response = await fetch('/api/exam-files');
                    const result = await response.json();

                    if (result.success && result.files) {
                        this.renderFiles(result.files);
                    } else {
                        this.renderFiles([]);
                    }
                } catch (error) {
                    console.error('Failed to load exam files:', error);
                    this.renderFiles([]);
                }
            }

            renderFiles(files) {
                const grid = document.getElementById('current-files-grid');
                
                if (!files || files.length === 0) {
                    grid.innerHTML = '<div class="no-files-message">No exam files found in practice-server/exam-files/</div>';
                    return;
                }

                grid.innerHTML = files.map(file => `
                    <div class="file-card">
                        <div class="file-name">${file.name || file.path}</div>
                        <div class="file-info">
                            Size: ${this.formatFileSize(file.size || 0)}<br>
                            Type: ${this.getFileType(file.name || file.path)}
                        </div>
                    </div>
                `).join('');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            getFileType(fileName) {
                const ext = fileName.split('.').pop().toLowerCase();
                const types = {
                    'js': 'JavaScript',
                    'html': 'HTML',
                    'css': 'CSS',
                    'json': 'JSON',
                    'md': 'Markdown',
                    'txt': 'Text'
                };
                return types[ext] || ext.toUpperCase();
            }
        }

        // Initialize file manager
        const fileManager = new FileManager();

        console.log('üöÄ Smart Teacher Dashboard loaded and ready');
    </script>
</body>

</html>