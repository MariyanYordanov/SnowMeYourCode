<!DOCTYPE html>
<html lang="bg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Workspace - Exam Monitor Modal</title>

    <!-- CSS Files -->
    <link rel="stylesheet" href="css/student.css">
    <link rel="stylesheet" href="css/editor.css">

    <style>
        /* Additional styles for modal system */
        .login-status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .login-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .login-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .login-status.loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .login-form {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-form input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .login-form button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .login-form button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Connection status indicator */
        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* Modal preparation styles */
        body.modal-exam-active {
            overflow: hidden !important;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .login-form {
                width: 95%;
                padding: 30px 20px;
            }

            .login-form h2 {
                font-size: 24px;
            }

            .login-form input,
            .login-form button {
                font-size: 16px;
                padding: 15px;
            }
        }
    </style>
</head>

<body>
    <!-- Login Form -->
    <div id="login-form" class="login-form">
        <h2>üéì –í—Ö–æ–¥ –∑–∞ –∏–∑–ø–∏—Ç</h2>
        <p style="color: #666; margin-bottom: 25px; text-align: center;">
            –ò–∑–ø–∏—Ç—ä—Ç —â–µ —Å–µ –ø—Ä–æ–≤–µ–¥–µ –≤ –∑–∞—â–∏—Ç–µ–Ω –º–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü
        </p>

        <input type="text" id="student-name" placeholder="–ò–º–µ –∏ —Ñ–∞–º–∏–ª–∏—è (–Ω–∞–ø—Ä. –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤)" autocomplete="off"
            maxlength="50">

        <input type="text" id="student-class" placeholder="–ö–ª–∞—Å (–Ω–∞–ø—Ä. 11–ê)" autocomplete="off" maxlength="10">

        <button onclick="joinExam()" id="login-btn">
            üöÄ –í–ª–µ–∑ –≤ –∏–∑–ø–∏—Ç–∞
        </button>

        <div id="login-status" class="login-status">
            <!-- Login status messages will appear here -->
        </div>

        <div
            style="margin-top: 30px; padding: 15px; background: #e9ecef; border-radius: 8px; font-size: 14px; color: #495057;">
            <strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>–ò–∑–ø–∏—Ç—ä—Ç —â–µ —Å–µ –æ—Ç–≤–æ—Ä–∏ –≤ –∑–∞—â–∏—Ç–µ–Ω –º–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü</li>
                <li>–í—Å–∏—á–∫–∏ –æ–ø–∏—Ç–∏ –∑–∞ –Ω–∞–ø—É—Å–∫–∞–Ω–µ —â–µ –±—ä–¥–∞—Ç –±–ª–æ–∫–∏—Ä–∞–Ω–∏</li>
                <li>–ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —â–µ –≤–∏–¥–∏—Ç–µ —á–µ—Ä–≤–µ–Ω –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç–µ–ª–µ–Ω –µ–∫—Ä–∞–Ω</li>
                <li>–ú–æ–∂–µ—Ç–µ –¥–∞ —Ä–∞–±–æ—Ç–∏—Ç–µ —Å–∞–º–æ –≤ –∫–æ–¥–æ–≤–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä</li>
            </ul>
        </div>
    </div>

    <!-- Hidden workspace template (will be moved to modal) -->
    <div id="workspace" style="display: none;">
        <!-- This will be cloned into the modal -->
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Inline ExamModalSystem to avoid loading issues -->
    <script>
        /**
         * Exam Modal System - Entire Exam runs in Modal Window
         * Any attempt to leave shows RED SCREEN immediately
         */
        class ExamModalSystem {
            constructor(socket) {
                this.socket = socket;
                this.isExamModalActive = false;
                this.isRedScreenVisible = false;
                this.violations = 0;
                this.examModal = null;
                this.redScreenModal = null;
                this.eventListeners = [];
                this.focusMonitor = null;
                this.examTimer = null;

                console.log('üè¢ Exam Modal System initialized');
            }

            /**
             * Start exam in modal window
             */
            startExamInModal(examData) {
                if (this.isExamModalActive) return;

                console.log('üöÄ Starting exam in modal window...');

                // Hide original page content
                this.hideOriginalContent();

                // Create exam modal
                this.createExamModal(examData);

                // Setup complete protection
                this.setupModalProtection();

                this.isExamModalActive = true;

                console.log('‚úÖ Exam modal active with full protection');
            }

            /**
             * Hide original page content
             */
            hideOriginalContent() {
                // Hide login form
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.style.display = 'none';
                }

                // Hide any other content
                const body = document.body;
                Array.from(body.children).forEach(child => {
                    if (child.id !== 'examModal' && child.id !== 'redScreenModal') {
                        child.style.display = 'none';
                    }
                });
            }

            /**
             * Create exam modal with workspace
             */
            createExamModal(examData) {
                // Create modal container
                this.examModal = document.createElement('div');
                this.examModal.id = 'examModal';
                this.examModal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: white !important;
            z-index: 999998 !important;
            overflow: auto !important;
            font-family: Arial, sans-serif !important;
        `;

                // Create exam workspace HTML
                this.examModal.innerHTML = `
            <div class="exam-modal-content" style="padding: 20px; height: 100%; display: flex; flex-direction: column;">
                <!-- Exam Header -->
                <div class="exam-header" style="display: flex; justify-content: space-between; align-items: center; 
                     margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #007bff;">
                    <div class="exam-title">
                        <h2 style="margin: 0; color: #007bff;">üéì –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–∑–ø–∏—Ç –ø–æ –ø—Ä–æ–≥—Ä–∞–º–∏—Ä–∞–Ω–µ</h2>
                        <span id="modal-student-info" style="color: #666; font-size: 14px;">
                            ${examData.studentName} (${examData.studentClass})
                        </span>
                    </div>
                    <div class="exam-timer" style="background: #dc3545; color: white; padding: 10px 20px; 
                         border-radius: 5px; font-size: 18px; font-weight: bold;">
                        <div id="modal-timer">Loading...</div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="exam-content" style="flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; min-height: 0;">
                    <!-- Code Editor Section -->
                    <div class="editor-section" style="display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 8px;">
                        <div class="editor-header" style="display: flex; justify-content: space-between; align-items: center; 
                             padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                            <h3 style="margin: 0; color: #333;">üìù –ö–æ–¥ —Ä–µ–¥–∞–∫—Ç–æ—Ä</h3>
                            <div class="editor-controls">
                                <button id="modal-save-code" style="background: #28a745; color: white; border: none; 
                                        padding: 8px 16px; border-radius: 4px; margin-right: 8px; cursor: pointer;">
                                    üíæ –ó–∞–ø–∞–∑–∏
                                </button>
                                <button id="modal-run-code" style="background: #007bff; color: white; border: none; 
                                        padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                    ‚ñ∂Ô∏è –ò–∑–ø—ä–ª–Ω–∏
                                </button>
                            </div>
                        </div>

                        <textarea id="modal-code-editor" style="flex: 1; border: none; padding: 15px; font-family: 'Courier New', monospace; 
                                 font-size: 14px; resize: none; outline: none; background: #f8f8f8;" 
                                 placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –≤–∞—à–∏—è JavaScript –∫–æ–¥ —Ç—É–∫...">${examData.lastCode || '// –î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ –∏–∑–ø–∏—Ç–∞!\n// –ù–∞–ø–∏—à–µ—Ç–µ –≤–∞—à–∏—è JavaScript –∫–æ–¥ —Ç—É–∫\n\nconsole.log("–ó–¥—Ä–∞–≤–µ–π, —Å–≤—è—Ç!");'}</textarea>
                    </div>

                    <!-- Output/Console Section -->
                    <div class="output-section" style="display: flex; flex-direction: column; border: 1px solid #ddd; border-radius: 8px;">
                        <div class="output-header" style="display: flex; justify-content: space-between; align-items: center; 
                             padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                            <h3 style="margin: 0; color: #333;">üì§ –ò–∑—Ö–æ–¥</h3>
                            <button id="modal-clear-output" style="background: #6c757d; color: white; border: none; 
                                    padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                üóëÔ∏è –ò–∑—á–∏—Å—Ç–∏
                            </button>
                        </div>
                        <div id="modal-code-output" style="flex: 1; padding: 15px; background: #fff; font-family: 'Courier New', monospace; 
                             font-size: 13px; overflow-y: auto; border: none;">
                            <div style="color: #666; font-style: italic;">
                                –ò–∑—Ö–æ–¥—ä—Ç –æ—Ç –≤–∞—à–∏—è –∫–æ–¥ —â–µ —Å–µ –ø–æ–∫–∞–∂–µ —Ç—É–∫...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exam Controls -->
                <div class="exam-controls" style="display: flex; justify-content: space-between; align-items: center; 
                     margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <button id="modal-finish-exam" style="background: #dc3545; color: white; border: none; 
                            padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                        üèÅ –ü—Ä–∏–∫–ª—é—á–∏ –∏–∑–ø–∏—Ç–∞
                    </button>
                    <div class="exam-info" style="color: #666; font-size: 14px;">
                        <div>Session: ${examData.sessionId}</div>
                        <div id="modal-last-saved">–ü–æ—Å–ª–µ–¥–Ω–æ –∑–∞–ø–∞–∑–µ–Ω–æ: –ù–∏–∫–æ–≥–∞</div>
                    </div>
                </div>
            </div>
        `;

                // Add modal to page
                document.body.appendChild(this.examModal);

                // Setup modal event listeners
                this.setupModalEventListeners();
            }

            /**
             * Setup event listeners for modal workspace
             */
            setupModalEventListeners() {
                // Save code button
                const saveBtn = this.examModal.querySelector('#modal-save-code');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => this.saveCode());
                }

                // Run code button
                const runBtn = this.examModal.querySelector('#modal-run-code');
                if (runBtn) {
                    runBtn.addEventListener('click', () => this.runCode());
                }

                // Clear output button
                const clearBtn = this.examModal.querySelector('#modal-clear-output');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearOutput());
                }

                // Finish exam button
                const finishBtn = this.examModal.querySelector('#modal-finish-exam');
                if (finishBtn) {
                    finishBtn.addEventListener('click', () => this.finishExam());
                }

                // Code editor change tracking
                const codeEditor = this.examModal.querySelector('#modal-code-editor');
                if (codeEditor) {
                    codeEditor.addEventListener('input', () => this.handleCodeChange());
                }
            }

            /**
             * Setup complete modal protection - TRAP EVERYTHING
             */
            setupModalProtection() {
                console.log('üõ°Ô∏è Setting up COMPLETE modal protection...');

                // Monitor for focus loss - IMMEDIATE RED SCREEN
                this.addListener(window, 'blur', () => {
                    if (this.isExamModalActive && !this.isRedScreenVisible) {
                        console.log('üö® Window blur detected - showing red screen');
                        this.showRedScreen('–ò–∑–ª–∏–∑–∞–Ω–µ –æ—Ç –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞ –Ω–∞ –∏–∑–ø–∏—Ç–∞');
                    }
                });

                // Monitor for visibility changes - IMMEDIATE RED SCREEN
                this.addListener(document, 'visibilitychange', () => {
                    if (document.hidden && this.isExamModalActive && !this.isRedScreenVisible) {
                        console.log('üö® Page hidden detected - showing red screen');
                        this.showRedScreen('–°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ç–∞–±–∞ –Ω–∞ –∏–∑–ø–∏—Ç–∞');
                    }
                });

                // Block keyboard shortcuts
                this.addListener(document, 'keydown', (e) => {
                    const blocked = this.checkBlockedShortcut(e);
                    if (blocked) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        this.showRedScreen(`–û–ø–∏—Ç –∑–∞ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ ${blocked}`);
                        return false;
                    }
                }, true);

                // Block navigation attempts
                this.addListener(window, 'beforeunload', (e) => {
                    if (this.isExamModalActive) {
                        e.preventDefault();
                        e.returnValue = '–ò–ó–ü–ò–¢ –í –•–û–î - –ù–ê–ü–£–°–ö–ê–ù–ï–¢–û –ï –ó–ê–ë–†–ê–ù–ï–ù–û!';

                        setTimeout(() => {
                            if (!this.isRedScreenVisible) {
                                this.showRedScreen('–û–ø–∏—Ç –∑–∞ –Ω–∞–ø—É—Å–∫–∞–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞');
                            }
                        }, 1);

                        return '–ò–ó–ü–ò–¢ –í –•–û–î - –ù–ê–ü–£–°–ö–ê–ù–ï–¢–û –ï –ó–ê–ë–†–ê–ù–ï–ù–û!';
                    }
                });

                // Continuous focus monitoring
                this.focusMonitor = setInterval(() => {
                    if (this.isExamModalActive && !document.hasFocus() && !this.isRedScreenVisible) {
                        console.log('üö® Focus lost in interval check');
                        this.showRedScreen('–ó–∞–≥—É–±–∞ –Ω–∞ —Ñ–æ–∫—É—Å –æ—Ç –∏–∑–ø–∏—Ç–∞');
                    }
                }, 100);
            }

            /**
             * Check if keyboard shortcut should be blocked
             */
            checkBlockedShortcut(e) {
                const shortcuts = {
                    'F5': () => e.code === 'F5',
                    'Ctrl+R': () => e.ctrlKey && e.code === 'KeyR',
                    'F12': () => e.code === 'F12',
                    'Ctrl+Shift+I': () => e.ctrlKey && e.shiftKey && e.code === 'KeyI',
                    'Ctrl+T': () => e.ctrlKey && e.code === 'KeyT',
                    'Ctrl+N': () => e.ctrlKey && e.code === 'KeyN',
                    'Ctrl+W': () => e.ctrlKey && e.code === 'KeyW',
                    'Alt+Tab': () => e.altKey && e.code === 'Tab',
                    'Ctrl+Tab': () => e.ctrlKey && e.code === 'Tab',
                    'Alt+F4': () => e.altKey && e.code === 'F4'
                };

                for (const [name, check] of Object.entries(shortcuts)) {
                    if (check()) {
                        return name;
                    }
                }
                return null;
            }

            /**
             * Show RED SCREEN modal over exam modal
             */
            showRedScreen(violation) {
                if (this.isRedScreenVisible) return;

                this.violations++;
                this.isRedScreenVisible = true;

                console.log(`üö® RED SCREEN: ${violation}`);

                // Report to server
                if (this.socket && this.socket.connected) {
                    this.socket.emit('suspicious-activity', {
                        activity: violation,
                        type: 'modal_violation',
                        severity: 'critical',
                        timestamp: Date.now(),
                        violationCount: this.violations
                    });
                }

                // Create red screen modal
                this.createRedScreenModal(violation);
            }

            /**
             * Create red screen modal
             */
            createRedScreenModal(violation) {
                this.redScreenModal = document.createElement('div');
                this.redScreenModal.id = 'redScreenModal';
                this.redScreenModal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(220, 53, 69, 0.98) !important;
            z-index: 999999 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-family: Arial, sans-serif !important;
            color: white !important;
        `;

                this.redScreenModal.innerHTML = `
            <div style="background-color: #dc3545; padding: 50px; border-radius: 15px; text-align: center;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 600px; width: 90%;">
                <div style="font-size: 36px; font-weight: bold; margin-bottom: 30px;">
                    üö® –ò–ó–ü–ò–¢–™–¢ –ï –ë–õ–û–ö–ò–†–ê–ù üö®
                </div>
                <div style="font-size: 20px; margin-bottom: 40px; line-height: 1.6;">
                    <strong>–ó–∞—Å–µ—á–µ–Ω–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ:</strong><br>
                    ${violation}<br><br>
                    <div style="font-size: 16px; color: #ffcccc;">
                        –ù–∞—Ä—É—à–µ–Ω–∏—è: ${this.violations}<br>
                        –í—Å–∏—á–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è —Å–∞ –±–ª–æ–∫–∏—Ä–∞–Ω–∏.
                    </div>
                </div>
                <div style="display: flex; gap: 30px; justify-content: center;">
                    <button id="continueExamFromRed" style="padding: 20px 40px; font-size: 18px; font-weight: bold;
                            border: none; border-radius: 8px; cursor: pointer; background-color: #28a745; color: white;">
                        ‚úÖ –ü—Ä–æ–¥—ä–ª–∂–∏ –∏–∑–ø–∏—Ç–∞
                    </button>
                    <button id="exitExamFromRed" style="padding: 20px 40px; font-size: 18px; font-weight: bold;
                            border: none; border-radius: 8px; cursor: pointer; background-color: #6c757d; color: white;">
                        ‚ùå –ù–∞–ø—É—Å–Ω–∏ –∏–∑–ø–∏—Ç–∞
                    </button>
                </div>
            </div>
        `;

                document.body.appendChild(this.redScreenModal);
                this.setupRedScreenButtons();
            }

            /**
             * Setup red screen button handlers
             */
            setupRedScreenButtons() {
                const continueBtn = this.redScreenModal.querySelector('#continueExamFromRed');
                const exitBtn = this.redScreenModal.querySelector('#exitExamFromRed');

                if (continueBtn) {
                    continueBtn.addEventListener('click', () => this.continueExam());
                }

                if (exitBtn) {
                    exitBtn.addEventListener('click', () => this.exitExam());
                }
            }

            /**
             * Continue exam - hide red screen
             */
            continueExam() {
                this.hideRedScreen();

                setTimeout(() => {
                    const codeEditor = this.examModal.querySelector('#modal-code-editor');
                    if (codeEditor) {
                        codeEditor.focus();
                    }
                }, 100);

                console.log('üü¢ Continued exam from red screen');
            }

            /**
             * Exit exam
             */
            exitExam() {
                if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –Ω–∞–ø—É—Å–Ω–µ—Ç–µ –∏–∑–ø–∏—Ç–∞?')) {
                    if (this.socket && this.socket.connected) {
                        this.socket.emit('exam-complete', {
                            reason: 'student_exit_violations',
                            violationCount: this.violations,
                            timestamp: Date.now()
                        });
                    }

                    this.endExam();
                    alert('–ò–∑–ø–∏—Ç—ä—Ç –µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω.');
                    window.close();
                }
            }

            /**
             * Hide red screen
             */
            hideRedScreen() {
                this.isRedScreenVisible = false;

                if (this.redScreenModal) {
                    this.redScreenModal.remove();
                    this.redScreenModal = null;
                }

                console.log('üü¢ Red screen hidden');
            }

            /**
             * Workspace functions
             */
            saveCode() {
                const codeEditor = this.examModal.querySelector('#modal-code-editor');
                if (!codeEditor) return;

                const code = codeEditor.value;

                if (this.socket && this.socket.connected) {
                    this.socket.emit('code-update', {
                        code: code,
                        filename: 'main.js',
                        timestamp: Date.now()
                    });
                }

                this.updateLastSaved('–°–µ–≥–∞');
                console.log('üíæ Code saved');
            }

            runCode() {
                const codeEditor = this.examModal.querySelector('#modal-code-editor');
                const outputEl = this.examModal.querySelector('#modal-code-output');

                if (!codeEditor || !outputEl) return;

                const code = codeEditor.value;
                outputEl.innerHTML = '';

                const originalLog = console.log;
                const outputs = [];

                console.log = (...args) => {
                    outputs.push(args.join(' '));
                    originalLog.apply(console, args);
                };

                try {
                    eval(code);

                    if (outputs.length > 0) {
                        outputs.forEach(output => {
                            const outputLine = document.createElement('div');
                            outputLine.style.cssText = 'margin-bottom: 5px; color: #333;';
                            outputLine.textContent = output;
                            outputEl.appendChild(outputLine);
                        });
                    } else {
                        outputEl.innerHTML = '<div style="color: #666; font-style: italic;">–ö–æ–¥—ä—Ç —Å–µ –∏–∑–ø—ä–ª–Ω–∏ –±–µ–∑ –∏–∑—Ö–æ–¥</div>';
                    }
                } catch (error) {
                    const errorEl = document.createElement('div');
                    errorEl.style.cssText = 'color: #dc3545; font-weight: bold;';
                    errorEl.textContent = `–ì—Ä–µ—à–∫–∞: ${error.message}`;
                    outputEl.appendChild(errorEl);
                }

                console.log = originalLog;
            }

            clearOutput() {
                const outputEl = this.examModal.querySelector('#modal-code-output');
                if (outputEl) {
                    outputEl.innerHTML = '<div style="color: #666; font-style: italic;">–ò–∑—Ö–æ–¥—ä—Ç –æ—Ç –≤–∞—à–∏—è –∫–æ–¥ —â–µ —Å–µ –ø–æ–∫–∞–∂–µ —Ç—É–∫...</div>';
                }
            }

            finishExam() {
                if (confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –ø—Ä–∏–∫–ª—é—á–∏—Ç–µ –∏–∑–ø–∏—Ç–∞?')) {
                    this.saveCode();

                    if (this.socket && this.socket.connected) {
                        this.socket.emit('exam-complete', {
                            reason: 'student_finish',
                            timestamp: Date.now()
                        });
                    }

                    this.endExam();
                    alert('üéâ –ò–∑–ø–∏—Ç—ä—Ç –µ –∑–∞–≤—ä—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                }
            }

            handleCodeChange() {
                this.updateLastSaved('–ù–µ–∑–∞–ø–∞–∑–µ–Ω–æ');
            }

            updateLastSaved(status) {
                const lastSavedEl = this.examModal.querySelector('#modal-last-saved');
                if (lastSavedEl) {
                    const time = status === '–°–µ–≥–∞' ? new Date().toLocaleTimeString() : status;
                    lastSavedEl.textContent = `–ü–æ—Å–ª–µ–¥–Ω–æ –∑–∞–ø–∞–∑–µ–Ω–æ: ${time}`;
                }
            }

            /**
             * Start exam timer
             */
            startTimer(timeLeft) {
                const timerEl = this.examModal.querySelector('#modal-timer');
                if (!timerEl) return;

                this.examTimer = setInterval(() => {
                    const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

                    timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    if (timeLeft < 15 * 60 * 1000) {
                        timerEl.style.background = '#dc3545';
                    } else if (timeLeft < 30 * 60 * 1000) {
                        timerEl.style.background = '#ffc107';
                        timerEl.style.color = '#000';
                    }

                    timeLeft -= 1000;

                    if (timeLeft <= 0) {
                        this.handleTimeExpired();
                    }
                }, 1000);
            }

            handleTimeExpired() {
                if (this.examTimer) {
                    clearInterval(this.examTimer);
                }
                this.endExam();
                alert('‚è∞ –í—Ä–µ–º–µ—Ç–æ –∑–∞ –∏–∑–ø–∏—Ç–∞ –∏–∑—Ç–µ—á–µ!');
            }

            endExam() {
                this.isExamModalActive = false;

                if (this.examTimer) {
                    clearInterval(this.examTimer);
                }

                if (this.focusMonitor) {
                    clearInterval(this.focusMonitor);
                }

                this.eventListeners.forEach(({ element, type, handler, capture }) => {
                    element.removeEventListener(type, handler, capture);
                });
                this.eventListeners = [];

                if (this.examModal) {
                    this.examModal.remove();
                }
                if (this.redScreenModal) {
                    this.redScreenModal.remove();
                }

                this.showCompletionScreen();
                console.log('üèÅ Exam ended');
            }

            showCompletionScreen() {
                document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: Arial, sans-serif;">
                <div style="background: white; padding: 50px; border-radius: 15px; text-align: center; 
                            box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 500px;">
                    <h1 style="color: #28a745; margin-bottom: 20px;">üéâ –ò–∑–ø–∏—Ç—ä—Ç –µ –∑–∞–≤—ä—Ä—à–µ–Ω!</h1>
                    <p style="font-size: 18px; color: #666; margin-bottom: 30px;">
                        –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ —É—á–∞—Å—Ç–∏–µ—Ç–æ –≤ –∏–∑–ø–∏—Ç–∞!
                    </p>
                    <div style="color: #999; margin-bottom: 30px;">
                        <div>–ü—Ä–∏–∫–ª—é—á–µ–Ω–æ –≤: ${new Date().toLocaleString()}</div>
                        <div>–û–±—â–æ –Ω–∞—Ä—É—à–µ–Ω–∏—è: ${this.violations}</div>
                    </div>
                    <button onclick="window.close()" style="background: #007bff; color: white; border: none; 
                            padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                        –ó–∞—Ç–≤–æ—Ä–∏ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞
                    </button>
                </div>
            </div>
        `;
            }

            addListener(element, type, handler, capture = false) {
                element.addEventListener(type, handler, capture);
                this.eventListeners.push({ element, type, handler, capture });
            }

            getStats() {
                return {
                    isExamModalActive: this.isExamModalActive,
                    isRedScreenVisible: this.isRedScreenVisible,
                    violations: this.violations,
                    eventListeners: this.eventListeners.length
                };
            }
        }

        // Export for global use
        window.ExamModalSystem = ExamModalSystem;
    </script>

    <script src="js/main.js"></script>

    <!-- Debug script loading -->
    <script>
        // Check if classes are loaded
        setTimeout(() => {
            console.log('üîç ExamModalSystem loaded:', !!window.ExamModalSystem);
            console.log('üîç ExamSystem loaded:', !!window.examSystem);
        }, 100);
    </script>

    <script>
        // Additional client-side validation
        document.addEventListener('DOMContentLoaded', function () {
            const nameInput = document.getElementById('student-name');
            const classInput = document.getElementById('student-class');
            const loginBtn = document.getElementById('login-btn');

            // Real-time input validation
            function validateInputs() {
                const name = nameInput.value.trim();
                const className = classInput.value.trim();

                const isValidName = name.length >= 2 && /^[–ê-–Ø–∞-—è\s]+$/.test(name);
                const isValidClass = className.length >= 2;

                loginBtn.disabled = !(isValidName && isValidClass);

                // Visual feedback
                nameInput.style.borderColor = name && !isValidName ? '#dc3545' : '';
                classInput.style.borderColor = className && !isValidClass ? '#dc3545' : '';
            }

            nameInput.addEventListener('input', validateInputs);
            classInput.addEventListener('input', validateInputs);

            // Initial validation
            validateInputs();

            // Auto-uppercase class input
            classInput.addEventListener('input', function () {
                this.value = this.value.toUpperCase();
            });

            // Prevent form submission on Enter if invalid
            [nameInput, classInput].forEach(input => {
                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (!loginBtn.disabled) {
                            joinExam();
                        }
                    }
                });
            });
        });

        // Show loading animation
        function showLoading() {
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.innerHTML = '‚è≥ –í–ª–∏–∑–∞–Ω–µ...';
                loginBtn.disabled = true;
            }
        }

        // Hide loading animation
        function hideLoading() {
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.innerHTML = 'üöÄ –í–ª–µ–∑ –≤ –∏–∑–ø–∏—Ç–∞';
                loginBtn.disabled = false;
            }
        }

        // Global function for HTML onclick handlers
        function joinExam() {
            if (window.examSystem) {
                showLoading();
                window.examSystem.handleLogin();

                // Hide loading after 5 seconds if no response
                setTimeout(() => {
                    if (document.getElementById('login-btn').disabled) {
                        hideLoading();
                    }
                }, 5000);
            } else {
                alert('–°–∏—Å—Ç–µ–º–∞—Ç–∞ –∑–∞ –∏–∑–ø–∏—Ç–∏ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞. –ú–æ–ª—è –ø—Ä–µ–∑–∞—Ä–µ–¥–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.');
            }
        }

        // Prevent accidental page leave during login
        window.addEventListener('beforeunload', function (e) {
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn && loginBtn.disabled) {
                e.preventDefault();
                e.returnValue = '–í–ª–∏–∑–∞–Ω–µ—Ç–æ –≤ –∏–∑–ø–∏—Ç–∞ –µ –≤ —Ö–æ–¥...';
                return '–í–ª–∏–∑–∞–Ω–µ—Ç–æ –≤ –∏–∑–ø–∏—Ç–∞ –µ –≤ —Ö–æ–¥...';
            }
        });

        // Debug info (remove in production)
        console.log('üéì Exam Monitor v2 - Modal System');
        console.log('üìÖ Build date:', new Date().toISOString());
        console.log('üåê User agent:', navigator.userAgent);
    </script>
</body>

</html>