/**
 * Anti-Cheat Security Module
 * Focus-based monitoring - tracks fullscreen exits instead of blocking keys
 * FIRST violation: choice screen, SECOND violation: automatic termination
 * Updated with Custom Dialog System for fullscreen-safe interactions
 */

// Import socket functions for reporting
import { reportSuspiciousActivity } from './socket.js';

// Import custom dialog system
import {
    showViolationExitDialog,
    showInfoDialog,
    hideCustomDialogs,
    isSecureDialogActive
} from './dialogs.js';

// Grace periods for accidental violations
const GRACE_PERIODS = {
    windowBlur: 3000, // 3 seconds
    documentHidden: 5000 // 5 seconds
};

// Violation tracking - only count fullscreen exits
let fullscreenViolationCount = 0;
const MAX_FULLSCREEN_VIOLATIONS = 1; // After 1 violation, next one terminates

// Timeouts for grace periods
let graceTimeouts = new Map();

/**
 * Setup anti-cheat monitoring (passive, before exam starts)
 */
export function setupAntiCheat() {
    try {
        console.log('üõ°Ô∏è Setting up focus-based anti-cheat monitoring...');

        // Setup fullscreen monitoring (always active)
        setupFullscreenMonitoring();

        console.log('‚úÖ Focus-based anti-cheat monitoring setup completed');
        return true;
    } catch (error) {
        console.error('‚ùå Failed to setup anti-cheat:', error);
        return false;
    }
}

/**
 * Activate full anti-cheat protection (when exam starts)
 */
export function activateAntiCheat() {
    try {
        console.log('üõ°Ô∏è Activating focus-based anti-cheat protection...');

        // Mark as active
        window.ExamApp.antiCheatActive = true;

        // Setup monitoring systems (no keyboard blocking)
        setupFocusMonitoring();
        setupVisibilityMonitoring();
        setupContextMenuBlocking();
        setupCopyPasteMonitoring();

        console.log('‚úÖ Focus-based anti-cheat protection activated');
        return true;
    } catch (error) {
        console.error('‚ùå Failed to activate anti-cheat:', error);
        return false;
    }
}

/**
 * Deactivate anti-cheat protection (when exam ends)
 */
export function deactivateAntiCheat() {
    try {
        console.log('üõ°Ô∏è Deactivating anti-cheat protection...');

        // Mark as inactive
        window.ExamApp.antiCheatActive = false;

        // Remove event listeners (no keyboard monitoring to remove)
        removeFocusMonitoring();
        removeVisibilityMonitoring();
        removeContextMenuBlocking();
        removeCopyPasteMonitoring();

        // Clear grace timeouts
        clearAllGraceTimeouts();

        // Remove fullscreen protection CSS
        const protectionStyle = document.getElementById('fullscreen-protection');
        if (protectionStyle) {
            protectionStyle.remove();
        }

        console.log('‚úÖ Anti-cheat protection deactivated');
    } catch (error) {
        console.error('‚ùå Error deactivating anti-cheat:', error);
    }
}

/**
 * Setup fullscreen monitoring (core mechanism)
 */
export function setupFullscreenMonitoring() {
    try {
        // Listen for fullscreen changes - this is our main detection method
        const fullscreenEvents = [
            'fullscreenchange',
            'webkitfullscreenchange',
            'mozfullscreenchange',
            'MSFullscreenChange'
        ];

        fullscreenEvents.forEach(eventName => {
            document.addEventListener(eventName, handleFullscreenChange);
        });

        console.log('üîí Focus-based fullscreen monitoring initialized');
    } catch (error) {
        console.error('‚ùå Failed to setup fullscreen monitoring:', error);
    }
}

/**
 * Enter fullscreen mode
 */
export function enterFullscreenMode() {
    try {
        console.log('üîí Entering fullscreen mode...');

        const element = document.documentElement;

        if (element.requestFullscreen) {
            element.requestFullscreen({ navigationUI: "hide" });
        } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
        } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
        } else {
            console.warn('‚ö†Ô∏è Fullscreen API not supported');
            return false;
        }

        return true;
    } catch (error) {
        console.error('‚ùå Failed to enter fullscreen:', error);
        return false;
    }
}

/**
 * Handle fullscreen change events - MAIN VIOLATION DETECTION
 */
function handleFullscreenChange() {
    try {
        const isFullscreen = !!(
            document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement
        );

        window.ExamApp.isFullscreen = isFullscreen;

        if (isFullscreen) {
            console.log('‚úÖ Entered fullscreen mode');
            updateFullscreenStatus('üîí Fullscreen –∞–∫—Ç–∏–≤–µ–Ω');

            // Inject fullscreen protection CSS
            injectFullscreenProtectionCSS();
        } else {
            console.log('‚ö†Ô∏è Exited fullscreen mode - VIOLATION DETECTED');
            updateFullscreenStatus('‚ö†Ô∏è Fullscreen –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω');

            // Handle violation if exam is active AND not in completion process
            if (window.ExamApp.isLoggedIn &&
                window.ExamApp.antiCheatActive &&
                !window.ExamApp.completionInProgress) {
                handleFullscreenViolation();
            } else if (window.ExamApp.completionInProgress) {
                console.log('üîÑ Fullscreen exit during completion process - allowed');
            }
        }
    } catch (error) {
        console.error('‚ùå Error handling fullscreen change:', error);
    }
}

/**
 * Inject fullscreen protection CSS (old student.css rules)
 */
function injectFullscreenProtectionCSS() {
    try {
        // Remove existing protection CSS
        const existingStyle = document.getElementById('fullscreen-protection');
        if (existingStyle) {
            existingStyle.remove();
        }

        // Create protection CSS using old student.css rules
        const style = document.createElement('style');
        style.id = 'fullscreen-protection';
        style.innerHTML = `
            /* FOCUS-BASED FULLSCREEN PROTECTION */
            html:fullscreen,
            body:fullscreen {
                margin: 0 !important;
                padding: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                overflow: hidden !important;
            }

            :fullscreen {
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                user-select: none !important;
            }

            /* Block browser UI in fullscreen */
            ::-webkit-fullscreen-controls {
                display: none !important;
                visibility: hidden !important;
            }

            :fullscreen::-moz-full-screen-ancestor {
                display: none !important;
            }

            /* Fullscreen protection overlay */
            body:fullscreen::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 100px;
                z-index: 999999;
                pointer-events: none;
                background: transparent;
                display: block;
            }
        `;

        document.head.appendChild(style);
        console.log('üîí Focus-based fullscreen protection CSS injected');
    } catch (error) {
        console.error('‚ùå Failed to inject fullscreen protection CSS:', error);
    }
}

/**
 * Handle fullscreen violation - CORE LOGIC: 1st choice, 2nd terminate
 */
function handleFullscreenViolation() {
    try {
        fullscreenViolationCount++;
        console.log(`üö´ Fullscreen exit violation #${fullscreenViolationCount}`);

        // Report to server
        reportSuspiciousActivity('fullscreen_exit', {
            violationNumber: fullscreenViolationCount,
            method: 'focus_detection', // How we detected it
            timestamp: Date.now()
        });

        if (fullscreenViolationCount === 1) {
            // FIRST violation - show choice screen with custom dialogs
            console.log('üü° First violation - showing choice screen with custom dialogs');

            showFirstViolationScreen();

        } else {
            // SECOND+ violation - automatic termination
            console.log('üî¥ AUTOMATIC TERMINATION: Second fullscreen violation');

            reportSuspiciousActivity('automatic_termination', {
                reason: 'second_fullscreen_exit',
                totalViolations: fullscreenViolationCount,
                timestamp: Date.now()
            });

            showAutomaticTerminationScreen();
        }

    } catch (error) {
        console.error('‚ùå Error handling fullscreen violation:', error);
        // Fallback - terminate immediately if error handling fails
        if (fullscreenViolationCount >= 2) {
            window.close();
        }
    }
}

/**
 * Show first violation screen - REMOVE AUTO RE-ENTER
 */
function showFirstViolationScreen() {
    try {
        // Close any existing custom dialogs first
        hideCustomDialogs();

        // Show traditional violation screen first
        if (window.ExamApp.showViolationScreen) {
            window.ExamApp.showViolationScreen(
                '–ò–∑–ª–∏–∑–∞–Ω–µ –æ—Ç fullscreen —Ä–µ–∂–∏–º –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ!\n\n' +
                '–¢–æ–≤–∞ –µ –≤–∞—à–µ—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.\n' +
                '–ü—Ä–∏ —Å–ª–µ–¥–≤–∞—â–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –∏–∑–ø–∏—Ç—ä—Ç —â–µ –±—ä–¥–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.\n\n' +
                '–ù–∞—Ç–∏—Å–Ω–µ—Ç–µ "–ü—Ä–æ–¥—ä–ª–∂–∏ –∏–∑–ø–∏—Ç–∞" –∑–∞ –¥–∞ —Å–µ –≤—ä—Ä–Ω–µ—Ç–µ –≤ fullscreen —Ä–µ–∂–∏–º.'
            );
        }

        // REMOVED: Auto re-enter fullscreen (was causing errors)
        // User must manually click "Continue" to re-enter fullscreen

    } catch (error) {
        console.error('‚ùå Error showing first violation screen:', error);
    }
}

/**
 * Show automatic termination screen with countdown
 */
function showAutomaticTerminationScreen() {
    try {
        // Close any existing custom dialogs
        hideCustomDialogs();

        // Show termination violation screen
        if (window.ExamApp.showViolationScreen) {
            window.ExamApp.showViolationScreen(
                '–ü–†–ï–ö–†–ê–¢–Ø–í–ê–ù–ï –ù–ê –ò–ó–ü–ò–¢–ê!\n\n' +
                '–í—Ç–æ—Ä–æ –∏–∑–ª–∏–∑–∞–Ω–µ –æ—Ç fullscreen —Ä–µ–∂–∏–º.\n\n' +
                '–ò–∑–ø–∏—Ç—ä—Ç —â–µ –±—ä–¥–µ –ø—Ä–µ–∫—Ä–∞—Ç–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–ª–µ–¥ 5 —Å–µ–∫—É–Ω–¥–∏.'
            );
        }

        // Disable anti-cheat to prevent further violations during termination
        window.ExamApp.antiCheatActive = false;

        // Auto-terminate after 5 seconds
        setTimeout(() => {
            console.log('üö´ TERMINATING EXAM: Second fullscreen violation');
            if (window.ExamApp.exitExam) {
                window.ExamApp.exitExam('automatic_termination');
            } else {
                window.close();
            }
        }, 5000);

    } catch (error) {
        console.error('‚ùå Error showing termination screen:', error);
        // Fallback - immediate termination
        window.close();
    }
}

/**
 * Setup focus monitoring (detect alt+tab, window switching)
 */
function setupFocusMonitoring() {
    window.addEventListener('blur', handleWindowBlur);
    window.addEventListener('focus', handleWindowFocus);
}

function removeFocusMonitoring() {
    window.removeEventListener('blur', handleWindowBlur);
    window.removeEventListener('focus', handleWindowFocus);
}

/**
 * Handle window blur (focus lost)
 */
function handleWindowBlur() {
    if (!window.ExamApp.antiCheatActive) return;

    try {
        console.log('üëÅÔ∏è Window lost focus');

        // Skip focus warnings if secure dialog is active
        if (isSecureDialogActive()) {
            console.log('üîí Secure dialog active - skipping focus warning');
            return;
        }

        // Report to server (for monitoring, not violations)
        reportSuspiciousActivity('window_blur', {
            timestamp: Date.now()
        });

        // Give grace period for accidental clicks
        const timeoutId = setTimeout(() => {
            if (!document.hasFocus() &&
                window.ExamApp.antiCheatActive &&
                !isSecureDialogActive()) {
                // Show warning using custom dialog (not counted as violation)
                showFocusWarningDialog();
            }
        }, GRACE_PERIODS.windowBlur);

        graceTimeouts.set('windowBlur', timeoutId);
    } catch (error) {
        console.error('‚ùå Error handling window blur:', error);
    }
}

/**
 * Show focus warning using custom dialog
 */
function showFocusWarningDialog() {
    try {
        // Check if dialog system is available
        if (window.ExamApp.dialogSystemActive && showInfoDialog) {
            showInfoDialog({
                title: '–í–Ω–∏–º–∞–Ω–∏–µ',
                message: '–ò–∑–ª–∏–∑–∞–Ω–µ –æ—Ç –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞ –Ω–∞ –∏–∑–ø–∏—Ç–∞ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ!\n\n–ú–æ–ª—è —Ñ–æ–∫—É—Å–∏—Ä–∞–π—Ç–µ —Å–µ –≤—ä—Ä—Ö—É –∏–∑–ø–∏—Ç–∞.',
                confirmText: '–†–∞–∑–±—Ä–∞—Ö',
                type: 'warning'
            }).then(() => {
                console.log('üí¨ Focus warning acknowledged');
            }).catch(error => {
                console.error('‚ùå Error showing focus warning dialog:', error);
            });
        } else {
            // Fallback to violation screen
            if (window.ExamApp.showViolationScreen) {
                window.ExamApp.showViolationScreen('–ò–∑–ª–∏–∑–∞–Ω–µ –æ—Ç –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞ –Ω–∞ –∏–∑–ø–∏—Ç–∞ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ!\n\n–ú–æ–ª—è —Ñ–æ–∫—É—Å–∏—Ä–∞–π—Ç–µ —Å–µ –≤—ä—Ä—Ö—É –∏–∑–ø–∏—Ç–∞.');
            }
        }
    } catch (error) {
        console.error('‚ùå Error showing focus warning:', error);
    }
}

/**
 * Handle window focus (focus regained)
 */
function handleWindowFocus() {
    if (!window.ExamApp.antiCheatActive) return;

    try {
        console.log('üëÅÔ∏è Window regained focus');

        // Clear grace timeout
        const timeoutId = graceTimeouts.get('windowBlur');
        if (timeoutId) {
            clearTimeout(timeoutId);
            graceTimeouts.delete('windowBlur');
        }

        // Hide any warning dialogs when focus is regained
        if (window.ExamApp.dialogSystemActive) {
            hideCustomDialogs();
        }

    } catch (error) {
        console.error('‚ùå Error handling window focus:', error);
    }
}

/**
 * Setup visibility monitoring
 */
function setupVisibilityMonitoring() {
    document.addEventListener('visibilitychange', handleVisibilityChange);
}

function removeVisibilityMonitoring() {
    document.removeEventListener('visibilitychange', handleVisibilityChange);
}

/**
 * Handle visibility change
 */
function handleVisibilityChange() {
    if (!window.ExamApp.antiCheatActive) return;

    try {
        if (document.hidden) {
            console.log('üëÅÔ∏è Document hidden');

            // Skip warnings if secure dialog is active
            if (isSecureDialogActive()) {
                console.log('üîí Secure dialog active - skipping visibility warning');
                return;
            }

            reportSuspiciousActivity('document_hidden', {
                timestamp: Date.now()
            });

            // Show warning after grace period (not counted as violation)
            const timeoutId = setTimeout(() => {
                if (document.hidden &&
                    window.ExamApp.antiCheatActive &&
                    !isSecureDialogActive()) {
                    showVisibilityWarningDialog();
                }
            }, GRACE_PERIODS.documentHidden);

            graceTimeouts.set('documentHidden', timeoutId);
        } else {
            // Clear grace timeout when visible again
            const timeoutId = graceTimeouts.get('documentHidden');
            if (timeoutId) {
                clearTimeout(timeoutId);
                graceTimeouts.delete('documentHidden');
            }

            // Hide warning dialogs when visibility is restored (but not secure dialogs)
            if (window.ExamApp.dialogSystemActive && !isSecureDialogActive()) {
                hideCustomDialogs();
            }
        }
    } catch (error) {
        console.error('‚ùå Error handling visibility change:', error);
    }
}

/**
 * Show visibility warning using custom dialog
 */
function showVisibilityWarningDialog() {
    try {
        // Check if dialog system is available
        if (window.ExamApp.dialogSystemActive && showInfoDialog) {
            showInfoDialog({
                title: '–í–Ω–∏–º–∞–Ω–∏–µ',
                message: '–°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ!\n\n–ú–æ–ª—è –≤—ä—Ä–Ω–µ—Ç–µ —Å–µ –∫—ä–º –∏–∑–ø–∏—Ç–∞.',
                confirmText: '–†–∞–∑–±—Ä–∞—Ö',
                type: 'warning'
            }).then(() => {
                console.log('üí¨ Visibility warning acknowledged');
            }).catch(error => {
                console.error('‚ùå Error showing visibility warning dialog:', error);
            });
        } else {
            // Fallback to violation screen
            if (window.ExamApp.showViolationScreen) {
                window.ExamApp.showViolationScreen('–°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–∑–æ—Ä–µ—Ü–∞ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ!\n\n–ú–æ–ª—è –≤—ä—Ä–Ω–µ—Ç–µ —Å–µ –∫—ä–º –∏–∑–ø–∏—Ç–∞.');
            }
        }
    } catch (error) {
        console.error('‚ùå Error showing visibility warning:', error);
    }
}

/**
 * Setup context menu blocking
 */
function setupContextMenuBlocking() {
    document.addEventListener('contextmenu', handleContextMenu, { capture: true });
}

function removeContextMenuBlocking() {
    document.removeEventListener('contextmenu', handleContextMenu, { capture: true });
}

/**
 * Handle context menu attempts (minor violation - warning only)
 */
function handleContextMenu(e) {
    if (!window.ExamApp.antiCheatActive) return;

    try {
        // Allow context menu only in editor area
        const editorArea = e.target.closest('#monaco-editor');
        if (!editorArea) {
            e.preventDefault();

            // Report but don't count as serious violation
            reportSuspiciousActivity('context_menu', {
                timestamp: Date.now()
            });

            // Show brief warning using custom dialog
            showContextMenuWarning();

            return false;
        }
    } catch (error) {
        console.error('‚ùå Error handling context menu:', error);
    }
}

/**
 * Show context menu warning
 */
function showContextMenuWarning() {
    try {
        if (window.ExamApp.dialogSystemActive && showInfoDialog) {
            showInfoDialog({
                title: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ',
                message: '–î–µ—Å–Ω–∏—è—Ç –∫–ª–∏–∫ –µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø–æ –≤—Ä–µ–º–µ –Ω–∞ –∏–∑–ø–∏—Ç–∞!',
                confirmText: '–†–∞–∑–±—Ä–∞—Ö',
                type: 'warning'
            }).catch(error => {
                console.error('‚ùå Error showing context menu warning:', error);
            });
        }
    } catch (error) {
        console.error('‚ùå Error showing context menu warning:', error);
    }
}

/**
 * Setup copy/paste monitoring
 */
function setupCopyPasteMonitoring() {
    document.addEventListener('copy', handleCopyAttempt, { capture: true });
    document.addEventListener('paste', handlePasteAttempt, { capture: true });
    document.addEventListener('cut', handleCutAttempt, { capture: true });
}

function removeCopyPasteMonitoring() {
    document.removeEventListener('copy', handleCopyAttempt, { capture: true });
    document.removeEventListener('paste', handlePasteAttempt, { capture: true });
    document.removeEventListener('cut', handleCutAttempt, { capture: true });
}

/**
 * Handle copy attempts (minor violation - warning only)
 */
function handleCopyAttempt(e) {
    if (!window.ExamApp.antiCheatActive) return;

    try {
        // Allow copy only in editor area
        const editorArea = e.target.closest('#monaco-editor');
        if (!editorArea) {
            e.preventDefault();

            reportSuspiciousActivity('copy_attempt', {
                timestamp: Date.now()
            });

            showCopyPasteWarning('copy');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error handling copy attempt:', error);
    }
}

/**
 * Handle paste attempts (minor violation - warning only)
 */
function handlePasteAttempt(e) {
    if (!window.ExamApp.antiCheatActive) return;

    try {
        // Allow paste only in editor area
        const editorArea = e.target.closest('#monaco-editor');
        if (!editorArea) {
            e.preventDefault();

            reportSuspiciousActivity('paste_attempt', {
                timestamp: Date.now()
            });

            showCopyPasteWarning('paste');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error handling paste attempt:', error);
    }
}

/**
 * Handle cut attempts (minor violation - warning only)
 */
function handleCutAttempt(e) {
    if (!window.ExamApp.antiCheatActive) return;

    try {
        // Allow cut only in editor area
        const editorArea = e.target.closest('#monaco-editor');
        if (!editorArea) {
            e.preventDefault();

            reportSuspiciousActivity('cut_attempt', {
                timestamp: Date.now()
            });

            showCopyPasteWarning('cut');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Error handling cut attempt:', error);
    }
}

/**
 * Show copy/paste warning
 */
function showCopyPasteWarning(action) {
    try {
        if (window.ExamApp.dialogSystemActive && showInfoDialog) {
            const messages = {
                'copy': '–ö–æ–ø–∏—Ä–∞–Ω–µ—Ç–æ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ –∏–∑–≤—ä–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞!',
                'paste': '–ü–æ—Å—Ç–∞–≤—è–Ω–µ—Ç–æ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ –∏–∑–≤—ä–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞!',
                'cut': '–ò–∑—Ä—è–∑–≤–∞–Ω–µ—Ç–æ –µ –∑–∞–±—Ä–∞–Ω–µ–Ω–æ –∏–∑–≤—ä–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞!'
            };

            showInfoDialog({
                title: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ',
                message: messages[action] || '–î–µ–π—Å—Ç–≤–∏–µ—Ç–æ –µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ!',
                confirmText: '–†–∞–∑–±—Ä–∞—Ö',
                type: 'warning'
            }).catch(error => {
                console.error('‚ùå Error showing copy/paste warning:', error);
            });
        }
    } catch (error) {
        console.error('‚ùå Error showing copy/paste warning:', error);
    }
}

/**
 * Update fullscreen status display
 */
function updateFullscreenStatus(text) {
    try {
        const statusEl = document.getElementById('fullscreen-status');
        if (statusEl) {
            statusEl.textContent = text;
        }
    } catch (error) {
        console.error('‚ùå Failed to update fullscreen status:', error);
    }
}

/**
 * Clear all grace timeouts
 */
function clearAllGraceTimeouts() {
    for (const timeoutId of graceTimeouts.values()) {
        clearTimeout(timeoutId);
    }
    graceTimeouts.clear();
}

/**
 * Emergency violation reset (admin function)
 */
export function emergencyResetViolations() {
    try {
        // Reset fullscreen violation counter
        fullscreenViolationCount = 0;

        clearAllGraceTimeouts();

        // Hide both traditional violation screen and custom dialogs
        if (window.ExamApp.hideViolationScreen) {
            window.ExamApp.hideViolationScreen();
        }

        if (window.ExamApp.dialogSystemActive) {
            hideCustomDialogs();
        }

        console.log('üö® Emergency violation reset - fullscreen violations reset to 0');
        return true;
    } catch (error) {
        console.error('‚ùå Error in emergency violation reset:', error);
        return false;
    }
}

/**
 * Get current violation status (for debugging)
 */
export function getViolationStatus() {
    return {
        fullscreenViolationCount: fullscreenViolationCount,
        maxViolationsAllowed: MAX_FULLSCREEN_VIOLATIONS,
        nextViolationWillTerminate: fullscreenViolationCount >= MAX_FULLSCREEN_VIOLATIONS,
        antiCheatActive: window.ExamApp.antiCheatActive,
        isFullscreen: window.ExamApp.isFullscreen,
        dialogSystemActive: window.ExamApp.dialogSystemActive,
        completionInProgress: window.ExamApp.completionInProgress
    };
}